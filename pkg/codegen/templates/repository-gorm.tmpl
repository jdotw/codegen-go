{{$tag := .Tag}}
type repository struct {
	db  *gorm.DB
}

func NewGormRepository(ctx context.Context, connString string, logger log.Factory, tracer opentracing.Tracer) (Repository, error) {
	var r Repository
	{
		db, err := gorm.Open(postgres.Open(connString), &gorm.Config{})
		if err != nil {
			logger.For(ctx).Fatal("Failed to open db", zap.Error(err))
		}

		db.Use(gormopentracing.New(gormopentracing.WithTracer(tracer)))

    // TODO: Ensure these migrations are correct
    // The OpenAPI Spec used to generate this code often uses
    // results in AutoMigrate statements being generated for 
    // request/response body objects instead of actual data models
    {{range uniqueResponseBodyTypes .Ops}}
		err = db.AutoMigrate(&{{lower $tag}}api.{{.}}{})
		if err != nil {
			logger.For(ctx).Fatal("Failed to migrate db for type {{.}}", zap.Error(err))
		}
    {{end}}

		r = &repository{db: db}
	}

	return r, nil
}


{{range .Ops}}
{{$hasParams := .RequiresParamObject -}}
{{$pathParams := .PathParams -}}
{{$opid := .OperationId -}}
{{$tag := .Tag -}}
{{$successResponse := getSuccessResponseTypeDefinition .}}
  func (p *repository) {{$opid}}(ctx context.Context{{genParamArgs .PathParams}}{{range .Bodies}}, {{lcFirst $opid}}{{.Suffix}}Request *{{$opid}}{{.Suffix}}Request{{end}}) (*{{lower $tag}}api.{{$successResponse.Schema.GoType}}, error) {
    {{if isCreate .}}
    var tx *gorm.DB
	  var v {{lower $tag}}api.{{$successResponse.Schema.GoType}}
    {{$opBodies := .Bodies}}
    {{range $opBodies}}
    tx = p.db.WithContext(ctx).Model(&{{lower $tag}}api.{{$successResponse.Schema.GoType}}{}).Create({{lcFirst $opid}}{{.Suffix}}Request)
    if (tx.Error != nil) {
      return nil, tx.Error
    }
    {{end}}
    {{if isBoolResponseType $successResponse}}
    v = true
    {{end}}
    return &v, nil
    {{end}}
    {{if isGet .}}
    // TODO: Check the .First query as codegen is not able
    // to elegantly deal with multiple request parameters
	  var v {{lower $tag}}api.{{$successResponse.Schema.GoType}}
	  tx := p.db.WithContext(ctx).Model(&{{lower $tag}}api.{{$successResponse.Schema.GoType}}{}).First(&v, "{{range $pathParams -}}{{.GoVariableName}} = ? {{end}}"{{range $pathParams -}}, {{.GoVariableName}}{{end}})
	  if tx.Error == gorm.ErrRecordNotFound {
		  return nil, recorderrors.ErrNotFound
  	}
  	return &v, tx.Error
    {{end}}
    {{if isUpdate .}}
    // TODO: Check the .Where queries as codegen is not able
    // to elegantly deal with multiple request parameters
	  var v {{lower $tag}}api.{{$successResponse.Schema.GoType}}
    {{range .Bodies}}
  	tx := p.db.WithContext(ctx).Model(&{{lower $tag}}api.{{$successResponse.Schema.GoType}}{}){{range $pathParams -}}.Where("{{.GoVariableName}} = ?", {{.GoVariableName}}){{end}}.UpdateColumns({{lcFirst $opid}}{{.Suffix}}Request)
	  if tx.RowsAffected == 0 {
		  return nil, recorderrors.ErrNotFound
	  }
    {{end}}
  	return &v, tx.Error
    {{end}}
    {{if isOther .}}
    // TODO: Unable to generate code for this Operation
    return nil, errors.New("Not Implemented")
    {{end}}
  }
{{end}}

